<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Karaoke BY ARM</title>
  <style>
    body { font-family: sans-serif; margin: 0; }
    #container { display: flex; flex-direction: row; }
    #main { flex: 1; padding: 20px; }
    #sidebar { width: 300px; padding: 20px; border-left: 1px solid #ccc; overflow-y: auto; max-height: 100vh; }
    #results button { display: block; margin: 10px 0; }
    iframe { width: 100%; height: 360px; margin: 20px 0; }
    .countdown { font-weight: bold; font-size: 1.2em; margin: 10px 0; color: darkred; }
    .playable-title { cursor: pointer; color: blue; text-decoration: underline; }
    .now-playing { background-color: #ffeeba; padding: 2px 6px; border-radius: 4px; }
    @media screen and (max-width: 768px), screen and (fullscreen) {
      #sidebar { display: none; }
    }
    #manual-add { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; }
    #apiKeyManager { display: none; border-top: 1px solid #aaa; margin-top: 20px; padding-top: 15px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="main">
      <h1>Karaoke BY ARM</h1>
      <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞" />
      <button onclick="searchKaraoke()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <div id="results"></div>
      <div id="player"></div>
      <div class="countdown" id="countdown"></div>
      <button onclick="skipSong()">‡πÄ‡∏û‡∏•‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      <button onclick="restartQueue()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
      <label><input type="checkbox" id="loopQueue"> ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏¥‡∏ß</label><br><br>
      <button onclick="exportQueue()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏õ‡πá‡∏ô karaoke.csv</button>
      <input type="file" accept=".csv" onchange="importQueue(event)">

      <div id="manual-add">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</h3>
        <input id="manualUrl" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" style="width: 60%;">
        <button onclick="addLinkToQueue()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</button>
      </div>

      <div style="margin-top:20px;">
        <button onclick="unlockManager()">üîí ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
        <input type="password" id="unlockCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á API Key">
      </div>

      <div id="apiKeyManager">
        <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ API Key</h3>
        <textarea id="apiKeyInput" rows="5" style="width: 100%;"></textarea><br>
        <button onclick="saveApiKeys()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key</button>
        <button onclick="exportApiKeys()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å API Key</button>
        <input type="file" accept=".txt" onchange="importApiKeys(event)">
      </div>
    </div>
    <div id="sidebar">
      <h2>‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á</h2>
      <ol id="queue"></ol>
    </div>
  </div>

  <footer style="text-align: center; padding: 20px; background-color: #f2f2f2; font-size: 0.9em;">
    ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà LINE ID : armtrue ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå : 0864910528
  </footer>

  <script>
    let queue = JSON.parse(localStorage.getItem('karaokeQueue') || '[]');
    let currentIndex = 0;
    let nowPlayingIndex = -1;
    let player;
    let ytPlayerReady = false;
    let countdownInterval;

    let apiKeys;
    try {
      apiKeys = JSON.parse(localStorage.getItem('apiKeys'));
      if (!Array.isArray(apiKeys)) throw "Invalid format";
    } catch {
      apiKeys = ["AIzaSyB5ho_NRgYf8yZZgBGqP6LrEB4N2NsV85g"];
      localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
    }

    function unlockManager() {
      const code = document.getElementById('unlockCode').value;
      if (code === 'nimda') {
        document.getElementById('apiKeyManager').style.display = 'block';
        document.getElementById('apiKeyInput').value = apiKeys.join("\n");
      } else {
        alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    }

    function saveApiKeys() {
      const lines = document.getElementById('apiKeyInput').value.trim().split(/\r?\n/);
      localStorage.setItem('apiKeys', JSON.stringify(lines));
      apiKeys = lines;
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
    }

    function exportApiKeys() {
      const text = apiKeys.join("\n");
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "api_keys.txt";
      a.click();
    }

    function importApiKeys(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const lines = reader.result.trim().split(/\r?\n/);
        localStorage.setItem('apiKeys', JSON.stringify(lines));
        apiKeys = lines;
        alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ API Key ‡πÅ‡∏•‡πâ‡∏ß");
        document.getElementById('apiKeyInput').value = lines.join("\n");
      };
      reader.readAsText(file);
    }

    function updateQueueDisplay() {
      const list = document.getElementById('queue');
      list.innerHTML = '';
      queue.forEach((song, i) => {
        const li = document.createElement('li');
        const titleSpan = document.createElement('span');
        titleSpan.textContent = song.title;
        titleSpan.className = 'playable-title';
        if (i === nowPlayingIndex) titleSpan.classList.add('now-playing');
        titleSpan.onclick = () => playSongAt(i);
        const removeBtn = document.createElement('button');
        removeBtn.textContent = '‡∏•‡∏ö';
        removeBtn.onclick = () => {
          queue.splice(i, 1);
          if (i <= currentIndex && currentIndex > 0) currentIndex--;
          localStorage.setItem('karaokeQueue', JSON.stringify(queue));
          updateQueueDisplay();
        };
        li.appendChild(titleSpan);
        li.appendChild(document.createTextNode(' '));
        li.appendChild(removeBtn);
        list.appendChild(li);
      });
    }

    function playSongAt(index) {
      if (!ytPlayerReady || !queue[index]) return;
      nowPlayingIndex = index;
      currentIndex = index + 1;
      localStorage.setItem('karaokeQueue', JSON.stringify(queue));
      updateQueueDisplay();
      const videoId = queue[index].videoId;
      const playerDiv = document.getElementById('player');
      playerDiv.innerHTML = '<div id="ytplayer"></div>';
      player = new YT.Player('ytplayer', {
        height: '360', width: '100%', videoId: videoId,
        events: {
          'onReady': (event) => { event.target.playVideo(); updateCountdown(); },
          'onStateChange': (event) => {
            if (event.data === YT.PlayerState.ENDED) skipSong();
          }
        }
      });
    }

    function skipSong() {
      if (currentIndex < queue.length) {
        playSongAt(currentIndex);
      } else if (document.getElementById('loopQueue').checked) {
        currentIndex = 0;
        playSongAt(currentIndex);
      }
    }

    function restartQueue() {
      currentIndex = 0;
      playSongAt(0);
    }

    function updateCountdown() {
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        if (player?.getDuration && player?.getCurrentTime) {
          const duration = player.getDuration();
          const current = player.getCurrentTime();
          const remaining = Math.max(0, Math.round(duration - current));
          document.getElementById('countdown').textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${remaining} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
      }, 1000);
    }

    function exportQueue() {
      const csv = queue.map(q => `${q.title},${q.videoId}`).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'karaoke.csv';
      a.click();
    }

    function importQueue(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const lines = reader.result.trim().split(/\r?\n/);
        queue = [];
        const seen = new Set();
        lines.forEach(line => {
          const [title, videoId] = line.split(',');
          if (!seen.has(videoId)) {
            seen.add(videoId);
            queue.push({ title, videoId });
          }
        });
        currentIndex = 0;
        localStorage.setItem('karaokeQueue', JSON.stringify(queue));
        updateQueueDisplay();
        playSongAt(0);
      };
      reader.readAsText(file);
    }

    function searchKaraoke() {
      const query = document.getElementById('search').value + ' ‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞';
      let currentKeyIndex = 0;
      function tryFetch() {
        const key = apiKeys[currentKeyIndex];
        fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=3&q=${encodeURIComponent(query)}&key=${key}`)
          .then(res => {
            if (!res.ok && currentKeyIndex < apiKeys.length - 1) {
              currentKeyIndex++;
              tryFetch();
              return null;
            } else {
              return res.json();
            }
          })
          .then(data => {
            if (!data?.items) return;
            const results = document.getElementById('results');
            results.innerHTML = '';
            data.items.forEach(item => {
              const button = document.createElement('button');
              button.textContent = item.snippet.title;
              button.onclick = () => {
                queue.push({ title: item.snippet.title, videoId: item.id.videoId });
                localStorage.setItem('karaokeQueue', JSON.stringify(queue));
                updateQueueDisplay();
                if (queue.length === 1) playSongAt(0);
              };
              results.appendChild(button);
            });
          });
      }
      tryFetch();
    }

    function addLinkToQueue() {
      const url = document.getElementById('manualUrl').value.trim();
      const match = url.match(/(?:youtube\.com.*[?&]v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      if (!match) return alert("‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      const videoId = match[1];
      if (queue.find(q => q.videoId === videoId)) return;

      let keyIndex = 0;
      function fetchTitle() {
        const key = apiKeys[keyIndex];
        fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${key}`)
          .then(res => res.json())
          .then(data => {
            const title = data?.items?.[0]?.snippet?.title || `YouTube Video: ${videoId}`;
            queue.push({ title, videoId });
            localStorage.setItem('karaokeQueue', JSON.stringify(queue));
            updateQueueDisplay();
            if (queue.length === 1) playSongAt(0);
            document.getElementById('manualUrl').value = '';
          })
          .catch(() => {
            if (keyIndex < apiKeys.length - 1) {
              keyIndex++;
              fetchTitle();
            }
          });
      }
      fetchTitle();
    }

    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      ytPlayerReady = true;
      if (queue.length > 0) playSongAt(0);
    }

    document.getElementById('search').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') searchKaraoke();
    });

    updateQueueDisplay();
  </script>
</body>
</html>
