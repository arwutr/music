<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Karaoke BY ARM</title>
  <style>
    body { font-family: sans-serif; margin: 0; }
    #container { display: flex; flex-direction: row; }
    #main { flex: 1; padding: 20px; }
    #sidebar { width: 300px; padding: 20px; border-left: 1px solid #ccc; overflow-y: auto; max-height: 100vh; }
    #results button { display: block; margin: 10px 0; }
    iframe { width: 100%; height: 360px; margin: 20px 0; }
    .countdown { font-weight: bold; font-size: 1.2em; margin: 10px 0; color: darkred; }
    .playable-title { cursor: pointer; color: blue; text-decoration: underline; }
    .now-playing { background-color: #ffeeba; padding: 2px 6px; border-radius: 4px; }
    #manual-add, #apiKeyManager { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ccc; }
    @media screen and (max-width: 768px) { #sidebar { display: none; } }
  </style>
</head>
<body>
  <div id="container">
    <div id="main">
      <h1>Karaoke BY ARM</h1>
      <input id="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏•‡∏á‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞" />
      <button onclick="searchKaraoke()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <div id="results"></div>
      <div id="player"></div>
      <div class="countdown" id="countdown"></div>
      <button onclick="playNext()">‡πÄ‡∏û‡∏•‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      <button onclick="restartQueue()">‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
      <label><input type="checkbox" id="loopQueue"> ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡∏¥‡∏ß</label><br><br>

      <button onclick="exportQueue()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ñ‡∏¥‡∏ß</button>
      <input type="file" id="queueFile" accept=".csv" onchange="importQueue(event)" /><br><br>

      <div id="manual-add">
        <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</h3>
        <input id="manualUrl" style="width:60%;" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" />
        <button onclick="addLinkToQueue()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</button>
      </div>

      <div style="margin-top:20px;">
        <button onclick="unlockManager()">üîí ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™</button>
        <input type="password" id="unlockCode" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á API Key">
      </div>

      <div id="apiKeyManager" style="display:none;">
        <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ API Key</h3>
        <textarea id="apiKeyInput" rows="5" style="width:100%;"></textarea><br>
        <button onclick="saveApiKeys()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button onclick="exportApiKeys()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>
        <input type="file" accept=".txt" onchange="importApiKeys(event)">
      </div>
    </div>

    <div id="sidebar">
      <h2>‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á</h2>
      <ol id="queue"></ol>
    </div>
  </div>

  <footer style="text-align:center; padding:20px; background:#f2f2f2;">
    ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà LINE ID : armtrue ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå : 0864910528
  </footer>

  <script>
    let queue = JSON.parse(localStorage.getItem('karaokeQueue') || '[]');
    let currentIndex = 0;
    let nowPlayingIndex = -1;
    let ytPlayerReady = false;
    let player, countdownInterval;

    let apiKeys = [];
    try {
      const stored = localStorage.getItem('apiKeys');
      apiKeys = stored ? JSON.parse(stored) : [];
    } catch { apiKeys = []; }

    if (apiKeys.length === 0) {
      fetch('apikeys.txt')
        .then(res => res.ok ? res.text() : '')
        .then(text => {
          const keys = text.trim().split(/\r?\n/).filter(line => line);
          if (keys.length > 0) {
            apiKeys = keys;
            localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
          }
        });
    }

    function unlockManager() {
      const code = document.getElementById('unlockCode').value;
      if (code === 'nimda') {
        document.getElementById('apiKeyManager').style.display = 'block';
        document.getElementById('apiKeyInput').value = apiKeys.join('\n');
      } else alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }

    function saveApiKeys() {
      const lines = document.getElementById('apiKeyInput').value.trim().split(/\r?\n/);
      localStorage.setItem('apiKeys', JSON.stringify(lines));
      apiKeys = lines;
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡πÅ‡∏•‡πâ‡∏ß");
    }

    function exportApiKeys() {
      const blob = new Blob([apiKeys.join('\n')], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'apikeys.txt';
      a.click();
    }

    function importApiKeys(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const lines = reader.result.trim().split(/\r?\n/);
        apiKeys = lines;
        localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
        document.getElementById('apiKeyInput').value = lines.join('\n');
        alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ API Key ‡πÅ‡∏•‡πâ‡∏ß");
      };
      reader.readAsText(file);
    }

    function searchKaraoke() {
      const query = document.getElementById('search').value + ' ‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞';
      let keyIndex = 0;
      function trySearch() {
        const key = apiKeys[keyIndex];
        fetch("https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=3&q=" + encodeURIComponent(query) + "&key=" + key)
          .then(res => {
            if (!res.ok && ++keyIndex < apiKeys.length) trySearch();
            else return res.json();
          })
          .then(data => {
            const results = document.getElementById('results');
            results.innerHTML = '';
            data?.items?.forEach(item => {
              const btn = document.createElement('button');
              btn.textContent = item.snippet.title;
              btn.onclick = () => addToQueue(item.id.videoId, item.snippet.title);
              results.appendChild(btn);
            });
          });
      }
      trySearch();
    }

    function addToQueue(videoId, title) {
      if (!queue.find(q => q.videoId === videoId)) {
        queue.push({ videoId, title });
        localStorage.setItem('karaokeQueue', JSON.stringify(queue));
        updateQueueDisplay();
        if (queue.length === 1) playNext();
      }
    }

    function addLinkToQueue() {
      const url = document.getElementById('manualUrl').value.trim();
      const match = url.match(/(?:v=|\.be\/)([\w-]{11})/);
      if (!match) return alert("‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      const videoId = match[1];
      let i = 0;
      function tryGetTitle() {
        fetch("https://www.googleapis.com/youtube/v3/videos?part=snippet&id=" + videoId + "&key=" + apiKeys[i])
          .then(res => res.ok ? res.json() : (++i < apiKeys.length && tryGetTitle()))
          .then(data => {
            const title = data?.items?.[0]?.snippet?.title || `YouTube Video: ${videoId}`;
            addToQueue(videoId, title);
            document.getElementById('manualUrl').value = '';
          });
      }
      tryGetTitle();
    }

    function updateQueueDisplay() {
      const list = document.getElementById('queue');
      list.innerHTML = '';
      queue.forEach((song, i) => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = song.title;
        span.className = 'playable-title';
        if (i === nowPlayingIndex) span.classList.add('now-playing');
        span.onclick = () => playSongAt(i);
        li.appendChild(span);
        list.appendChild(li);
      });
    }

    function playSongAt(i) {
      nowPlayingIndex = currentIndex = i;
      const song = queue[i];
      const div = document.getElementById('player');
      div.innerHTML = '<div id="ytplayer"></div>';
      if (window.YT?.Player) {
        player = new YT.Player('ytplayer', {
          height: '360',
          width: '100%',
          videoId: song.videoId,
          events: {
            'onReady': e => { e.target.playVideo(); updateRealCountdown(); },
            'onStateChange': onPlayerStateChange
          }
        });
      }
      updateQueueDisplay();
    }

    function onPlayerStateChange(e) {
      if (e.data === YT.PlayerState.ENDED) playNext();
    }

    function playNext() {
      if (++currentIndex >= queue.length) {
        if (document.getElementById('loopQueue').checked) currentIndex = 0;
        else return;
      }
      playSongAt(currentIndex);
    }

    function restartQueue() {
      currentIndex = 0;
      playNext();
    }

    function updateRealCountdown() {
      clearInterval(countdownInterval);
      countdownInterval = setInterval(() => {
        if (player?.getDuration && player?.getCurrentTime) {
          const d = player.getDuration(), c = player.getCurrentTime();
          document.getElementById('countdown').textContent = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${Math.max(0, Math.round(d - c))} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
      }, 1000);
    }

    function exportQueue() {
      const csv = queue.map(q => q.title + ',' + q.videoId).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'karaoke.csv';
      a.click();
    }

    function importQueue(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const lines = reader.result.trim().split('\n');
        queue = lines.map(line => {
          const [title, videoId] = line.split(',');
          return { title, videoId };
        });
        currentIndex = 0;
        localStorage.setItem('karaokeQueue', JSON.stringify(queue));
        updateQueueDisplay();
        playNext();
      };
      reader.readAsText(file);
    }

    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      ytPlayerReady = true;
      if (queue.length > 0) playSongAt(0);
    }

    window.onload = () => updateQueueDisplay();
  </script>
</body>
</html>
